# Руководство по решению проблем (Troubleshooting Guide)

Этот документ описывает основные технические проблемы, с которыми мы столкнулись при разработке бота, и их решения. Он поможет быстро диагностировать и устранить похожие неисправности в будущем.

---

### 1. Проблема: Оплата YooKassa не работает, бот не получает уведомления

*   **Симптом:** Пользователь совершает оплату, деньги списываются, но бот не выдает подписку. В логах нет никаких упоминаний о входящих запросах от YooKassa.
*   **Причина:** Бот работал в режиме `polling` (`dp.start_polling(bot)`). Этот режим "опрашивает" серверы Telegram на наличие новых сообщений, но не может принимать входящие HTTP-запросы (вебхуки) от сторонних сервисов, таких как YooKassa.
*   **Решение:** Полностью перевести бота на работу в режиме `webhook`.
    1.  **Добавили `aiohttp`:** Установили библиотеку и создали веб-сервер.
    2.  **Создали два эндпоинта в `main.py`:**
        *   `/webhook` для Telegram.
        *   `/yookassa/webhook` для YooKassa.
    3.  **Изменили запуск в `main.py`:** Вместо `dp.start_polling()` используется `web.run_app(app, ...)`, который запускает `aiohttp` сервер.
    4.  **Настроили ngrok:** Пробросили локальный порт (например, 8080) в интернет, чтобы YooKassa могла отправлять на него уведомления. URL из ngrok был прописан в `BASE_WEBHOOK_URL` в `.env` файле.

---

### 2. Проблема: Ошибка `KeyError: 'bot'` при обработке платежа

*   **Симптом:** Бот получает уведомление от YooKassa (это видно в логах), но падает с ошибкой `KeyError: 'bot'` и не выдает подписку.
*   **Причина:** Обработчик вебхука (`yookassa_webhook_handler` в `core/webhooks.py`) пытался получить доступ к объекту бота, чтобы выдать подписку и отправить сообщение. Однако, при создании веб-сервера `aiohttp` в `main.py`, мы забыли передать ему сам объект бота.
*   **Решение:** Добавить объект бота в контекст `aiohttp` приложения. Это делается одной строкой в `main.py` перед регистрацией обработчиков:

    ```python
    # main.py

    app = web.Application()

    # Ключевое исправление: передаем бота в контекст сервера
    app['bot'] = bot

    # ... регистрация обработчиков
    ```

---

### 3. Проблема: Ошибка `RuntimeWarning: coroutine ... was never awaited`

*   **Симптом:** Бот получает уведомление, но подписка не выдается. В логах появляется предупреждение, что корутина (асинхронная функция) не была "дождана".
*   **Причина:** Функция `give_subscription_to_user` в `database.py` была асинхронной (определена как `async def`), но при ее вызове в `core/webhooks.py` мы забыли использовать ключевое слово `await`.
*   **Решение:** Добавить `await` перед вызовом функции:

    ```python
    # core/webhooks.py

    # Было:
    # grant_subscription(user_id)

    # Стало:
    await grant_subscription(user_id)
    ```

---

### 4. Проблема: Ответы от AI содержат `**звездочки**` вместо жирного текста

*   **Симптом:** Бот присылает ответы от AI, но форматирование не применяется, и пользователь видит `**текст**`.
*   **Причина:** AI генерировал текст с разметкой **Markdown**, в то время как бот был настроен на отправку сообщений в формате **HTML** (`parse_mode=ParseMode.HTML`).
*   **Решение:** Изменить системную инструкцию (промпт) для AI, добавив требование использовать HTML-теги.

    ```python
    # core/integrations/deepseek.py

    system_prompt = "... Отвечай на русском языке. ВАЖНО: Для форматирования текста всегда используй HTML-теги: <b> для жирного текста, <i> для курсива. Никогда не используй Markdown (** или *)."
    ```

---

### 5. Проблема: Ошибки `NameError` и `ImportError` при запуске

*   **Симптом:** Бот не запускается и падает с ошибками `NameError: name '...' is not defined` или `ModuleNotFoundError`.
*   **Причина:** Множественные мелкие ошибки, связанные с отсутствием импортов или неправильной загрузкой переменных.
*   **Решение (Чек-лист):**
    1.  **Загрузка `.env`:** Убедиться, что `load_dotenv()` вызывается в самом начале `main.py`.
    2.  **Получение переменных:** Сразу после `load_dotenv()` считать все нужные переменные с помощью `os.getenv("...")`.
    3.  **Импорт `os`:** Убедиться, что `import os` присутствует в файле.
    4.  **Импорты `aiogram`:** Проверить, что все используемые классы (например, `DefaultBotProperties`) импортированы из правильных модулей `aiogram`.
    5.  **Запуск из venv:** Всегда запускать скрипты, используя интерпретатор из виртуального окружения (`/path/to/venv/bin/python3 script.py`), чтобы избежать проблем с отсутствующими библиотеками.
